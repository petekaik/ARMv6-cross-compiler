name: Build librespot for ARMv6 (Pi Zero)

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Build for multiple Debian versions to ensure library compatibility
        debian_distro: [bullseye, bookworm, trixie]

    permissions:
      contents: write

    name: Build ARMv6 on ${{ matrix.debian_distro }}

    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4

    # Caching Cargo Registry to speed up dependency downloads
    - name: Cache Cargo Registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-reg-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-reg-

    # Caching the build target to avoid recompiling everything
    - name: Cache Cargo Target
      uses: actions/cache@v4
      with:
        path: ./target-armv6
        key: ${{ runner.os }}-cargo-target-${{ matrix.debian_distro }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-cargo-target-${{ matrix.debian_distro }}-

    - name: Run Build in Native ARMv6 Environment
      uses: uraimo/run-on-architecture-action@v2
      with:
        arch: armv6
        distro: ${{ matrix.debian_distro }}
        
        # Mount workspace to share files between host and emulator
        githubToken: ${{ github.token }}
        
        # Install required ARMv6 system libraries inside the emulator
        install: |
          apt-get update
          apt-get install -y \
            git curl pkg-config build-essential \
            libasound2-dev libpulse-dev libavahi-client-dev libdbus-1-dev
          
          # Install Rust natively inside the ARMv6 container
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        
        run: |
          source $HOME/.cargo/env
          
          # Clone librespot source
          REPO_URL="https://github.com/librespot-org/librespot.git"
          REPO_PATH="/tmp/librespot-src"
          git clone --depth 1 "$REPO_URL" "$REPO_PATH"
          cd "$REPO_PATH"
          
          # Ensure we use the cached target directory if it exists
          mkdir -p /github/workspace/target-armv6
          ln -s /github/workspace/target-armv6 target

          # Build librespot. Since we are inside ARMv6, no cross-prefix needed.
          # We use rustls to avoid native OpenSSL linking issues.
          cargo build --release \
            --no-default-features \
            --features "rustls-tls-webpki-roots alsa-backend pulseaudio-backend with-avahi"
          
          # Copy the final binary to workspace for the next steps
          cp target/release/librespot /github/workspace/librespot-binary-${{ matrix.debian_distro }}

    - name: Validate Binary (ARMv6 Verification)
      run: |
        BIN="librespot-binary-${{ matrix.debian_distro }}"
        echo "Analyzing $BIN..."
        readelf -A "$BIN"
        
        # Strict check for Tag_CPU_arch: v6
        if readelf -A "$BIN" | grep -q "Tag_CPU_arch: v6"; then
          echo "✅ PASS: Architecture is confirmed ARMv6."
        else
          echo "❌ FAIL: Architecture is NOT ARMv6. Check logs."
          exit 1
        fi

    - name: Create Debian Package (.deb)
      id: package
      run: |
        # Install FPM on the host (x86) to create the package quickly
        sudo apt-get update && sudo apt-get install -y ruby ruby-dev rubygems build-essential
        sudo gem install --no-document fpm
        
        VERSION=$(date +%Y%m%d%H%M)
        OUTPUT_NAME="librespot_${VERSION}_armhf_${{ matrix.debian_distro }}.deb"
        
        # Determine ALSA package name based on Debian version (t64 transition)
        if [ "${{ matrix.debian_distro }}" = "bullseye" ]; then
            ALSA_PKG="libasound2"
        else
            ALSA_PKG="libasound2t64"
        fi

        # Build the .deb package
        fpm -s dir -t deb -a armhf -n librespot -v "${VERSION}" -p "${OUTPUT_NAME}" \
          --maintainer "Build-Bot <email@github.com>" \
          --description "Librespot ARMv6 (Pi Zero) - Debian ${{ matrix.debian_distro }}" \
          --depends libpulse0 \
          --depends "$ALSA_PKG" \
          --depends libavahi-client3 \
          --depends libdbus-1-3 \
          --after-install "packaging/postinst" \
          --deb-systemd "packaging/librespot.service" \
          "packaging/librespot.default=/etc/default/librespot" \
          "librespot-binary-${{ matrix.debian_distro }}=/usr/bin/librespot"
            
        echo "TAG_NAME=v${VERSION}-${{ matrix.debian_distro }}" >> $GITHUB_ENV
        echo "DEB_PACKAGE_NAME=${OUTPUT_NAME}" >> $GITHUB_ENV

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: librespot-${{ matrix.debian_distro }}
        path: ${{ env.DEB_PACKAGE_NAME }}

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: Librespot ARMv6 (${{ matrix.debian_distro }})
        body: |
          ### Librespot for Raspberry Pi Zero W / Pi 1
          - **Architecture:** ARMv6 (32-bit)
          - **OS Base:** Debian ${{ matrix.debian_distro }}
          - **Features:** ALSA, PulseAudio, Avahi, Rustls
        files: ${{ env.DEB_PACKAGE_NAME }}