name: Build librespot for ARMv6 (Pi Zero)

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # We define the base image manually to bypass missing action templates
        include:
          - debian_distro: bullseye
            base_image: arm32v6/debian:bullseye
          - debian_distro: bookworm
            base_image: arm32v6/debian:bookworm
          - debian_distro: trixie
            base_image: arm32v6/debian:trixie

    permissions:
      contents: write

    name: Build ARMv6 on ${{ matrix.debian_distro }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target-armv6
        key: ${{ runner.os }}-cargo-${{ matrix.debian_distro }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.debian_distro }}-

    - name: Run Build and Test
      uses: uraimo/run-on-arch-action@v3
      with:
        arch: armv6
        # Use 'image' instead of 'distro' to avoid "Dockerfile does not exist" error
        image: ${{ matrix.base_image }}
        githubToken: ${{ github.token }}
        
        install: |
          apt-get update
          apt-get install -y git curl pkg-config build-essential libasound2-dev libpulse-dev libavahi-client-dev libdbus-1-dev
          
          # Install Rust natively inside the emulated ARMv6 container
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        
        run: |
          source $HOME/.cargo/env
          
          # Clone librespot
          git clone --depth 1 https://github.com/librespot-org/librespot.git /tmp/librespot-src
          cd /tmp/librespot-src
          
          # Use workspace for target storage to persist cache
          mkdir -p /github/workspace/target-armv6
          ln -s /github/workspace/target-armv6 target

          # Build optimized for Pi Zero
          cargo build --release --no-default-features --features "rustls-tls-webpki-roots alsa-backend pulseaudio-backend with-avahi"
          
          # TEST: Ensure it runs on ARMv6 (QEMU will catch illegal instructions here)
          echo "Testing binary version execution..."
          ./target/release/librespot --version
          
          # EXPORT: Copy to workspace root where the host runner can see it
          cp ./target/release/librespot /github/workspace/librespot-binary-${{ matrix.debian_distro }}

    - name: Final Architecture Validation
      run: |
        BIN="librespot-binary-${{ matrix.debian_distro }}"
        
        if [ ! -f "$BIN" ]; then
          echo "❌ ERROR: $BIN not found! Printing workspace content:"
          ls -F
          exit 1
        fi
        
        echo "Validating $BIN with readelf..."
        readelf -A "$BIN"
        
        if readelf -A "$BIN" | grep -q "Tag_CPU_arch: v6"; then
          echo "✅ Success: Binary is ARMv6."
        else
          echo "❌ Error: Binary is NOT ARMv6!"
          exit 1
        fi

    - name: Create Debian Package (.deb)
      id: package
      run: |
        sudo apt-get update && sudo apt-get install -y ruby ruby-dev rubygems build-essential
        sudo gem install --no-document fpm
        
        VERSION=$(date +%Y%m%d%H%M)
        OUTPUT_NAME="librespot_${VERSION}_armhf_${{ matrix.debian_distro }}.deb"
        
        # Determine ALSA package (t64 transition in newer Debian)
        ALSA_PKG="libasound2"
        [ "${{ matrix.debian_distro }}" != "bullseye" ] && ALSA_PKG="libasound2t64"
        
        mkdir -p packaging
        [ ! -f packaging/librespot.service ] && echo -e "[Unit]\nDescription=Librespot\n[Service]\nExecStart=/usr/bin/librespot\n[Install]\nWantedBy=multi-user.target" > packaging/librespot.service
        [ ! -f packaging/postinst ] && echo -e "#!/bin/sh\nif ! id librespot >/dev/null 2>&1; then useradd -r -M librespot; fi\nsystemctl daemon-reload" > packaging/postinst && chmod +x packaging/postinst
        [ ! -f packaging/librespot.default ] && echo 'LIBRESPOT_OPTS="--name PiZero"' > packaging/librespot.default

        fpm -s dir -t deb -a armhf -n librespot -v "${VERSION}" -p "${OUTPUT_NAME}" \
          --maintainer "Build-Bot <email@github.com>" \
          --description "Librespot for ARMv6 Pi Zero - ${{ matrix.debian_distro }}" \
          --depends libpulse0 --depends "$ALSA_PKG" --depends libavahi-client3 --depends libdbus-1-3 \
          --after-install "packaging/postinst" \
          --deb-systemd "packaging/librespot.service" \
          "packaging/librespot.default=/etc/default/librespot" \
          "librespot-binary-${{ matrix.debian_distro }}=/usr/bin/librespot"
            
        echo "TAG_NAME=v${VERSION}-${{ matrix.debian_distro }}" >> $GITHUB_ENV
        echo "DEB_PACKAGE_NAME=${OUTPUT_NAME}" >> $GITHUB_ENV

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: librespot-${{ matrix.debian_distro }}
        path: ${{ env.DEB_PACKAGE_NAME }}

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: Librespot ARMv6 (${{ matrix.debian_distro }})
        files: ${{ env.DEB_PACKAGE_NAME }}