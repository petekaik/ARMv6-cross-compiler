name: Build librespot for ARMv6 (Pi Zero)

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        debian_distro: [bullseye, bookworm, trixie]

    permissions:
      contents: write

    name: Build ARMv6 on ${{ matrix.debian_distro }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target-armv6
        key: ${{ runner.os }}-cargo-${{ matrix.debian_distro }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.debian_distro }}-

    - name: Build and Test inside ARMv6 Container
      run: |
        # Luodaan rakennusskripti
        cat <<'EOF' > build_script.sh
        set -e
        apt-get update
        apt-get install -y git curl pkg-config build-essential libasound2-dev libpulse-dev libavahi-client-dev libdbus-1-dev
        
        # Asennetaan Rust
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        
        # Haetaan koodi
        git clone --depth 1 https://github.com/librespot-org/librespot.git /tmp/librespot-src
        cd /tmp/librespot-src
        
        # Käytetään välimuistia jos mahdollista
        if [ -d "/workspace/target-armv6" ]; then
          mkdir -p target
          cp -r /workspace/target-armv6/* target/ || true
        fi

        # Rakennus
        cargo build --release --no-default-features --features "rustls-tls-webpki-roots alsa-backend pulseaudio-backend with-avahi"
        
        # TESTI: Suoritetaan binääri emulaattorissa
        echo "Verifying binary execution..."
        ./target/release/librespot --version
        
        # Kopioidaan tulokset takaisin
        cp ./target/release/librespot /workspace/librespot-binary-${{ matrix.debian_distro }}
        cp -r target/* /workspace/target-armv6/ || true
        EOF

        chmod +x build_script.sh

        # Ajetaan skripti natiivissa ARMv6-ympäristössä
        docker run --rm \
          --platform linux/arm/v6 \
          -v "${{ github.workspace }}:/workspace" \
          -w /workspace \
          arm32v6/debian:${{ matrix.debian_distro }} \
          /bin/bash /workspace/build_script.sh

    - name: Final Architecture Validation
      run: |
        BIN="librespot-binary-${{ matrix.debian_distro }}"
        echo "Validating $BIN with readelf..."
        readelf -A "$BIN" | grep "Tag_CPU_arch: v6" || (echo "❌ Not ARMv6!" && exit 1)
        echo "✅ Architecture confirmed as ARMv6."

    - name: Create Debian Package (.deb)
      id: package
      run: |
        sudo apt-get update && sudo apt-get install -y ruby ruby-dev rubygems build-essential
        sudo gem install --no-document fpm
        
        VERSION=$(date +%Y%m%d%H%M)
        OUTPUT_NAME="librespot_${VERSION}_armhf_${{ matrix.debian_distro }}.deb"
        ALSA_PKG="libasound2"
        [ "${{ matrix.debian_distro }}" != "bullseye" ] && ALSA_PKG="libasound2t64"
        
        mkdir -p packaging
        echo -e "[Unit]\nDescription=Librespot\n[Service]\nExecStart=/usr/bin/librespot\n[Install]\nWantedBy=multi-user.target" > packaging/librespot.service
        echo -e "#!/bin/sh\nsystemctl daemon-reload" > packaging/postinst && chmod +x packaging/postinst
        echo 'LIBRESPOT_OPTS="--name PiZero"' > packaging/librespot.default

        fpm -s dir -t deb -a armhf -n librespot -v "${VERSION}" -p "${OUTPUT_NAME}" \
          --maintainer "Build-Bot <email@github.com>" \
          --description "Librespot ARMv6 (Pi Zero) - Debian ${{ matrix.debian_distro }}" \
          --depends libpulse0 --depends "$ALSA_PKG" --depends libavahi-client3 --depends libdbus-1-3 \
          --after-install "packaging/postinst" \
          --deb-systemd "packaging/librespot.service" \
          "packaging/librespot.default=/etc/default/librespot" \
          "librespot-binary-${{ matrix.debian_distro }}=/usr/bin/librespot"
            
        echo "TAG_NAME=v${VERSION}-${{ matrix.debian_distro }}" >> $GITHUB_ENV
        echo "DEB_PACKAGE_NAME=${OUTPUT_NAME}" >> $GITHUB_ENV

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: librespot-${{ matrix.debian_distro }}
        path: ${{ env.DEB_PACKAGE_NAME }}

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: Librespot ARMv6 (${{ matrix.debian_distro }})
        files: ${{ env.DEB_PACKAGE_NAME }}