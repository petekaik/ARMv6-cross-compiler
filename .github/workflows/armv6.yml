name: Build librespot for armv6

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bullseye
      options: --user root
    
    permissions:
      contents: write

    steps:
    - name: Set up and update build environment base
      run: |
        apt-get update
        apt-get install -y \
          git pkg-config \
          build-essential curl
      
    - name: APT Cache
      id: apt-cache
      uses: actions/cache@v3
      with:
        path: /var/cache/apt/archives
        key: ${{ runner.os }}-bullseye-apt-v1-${{ hashFiles('**/Dockerfile.builder') }}
        restore-keys: |
          ${{ runner.os }}-bullseye-apt-v1-

    - name: Install Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Cargo Registry Cache
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-v1-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-v1-

    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Update or clone librespot repository
      id: update_repo
      run: |
        REPO_URL="https://github.com/librespot-org/librespot.git"
        REPO_PATH="/tmp/librespot"
        
        if [ -d "$REPO_PATH" ]; then
          echo "Librespot repository found. Updating..."
          cd "$REPO_PATH"
          git fetch origin
          git reset --hard origin/HEAD
        else
          echo "Librespot repository not found. Cloning..."
          git clone --depth 1 "$REPO_URL" "$REPO_PATH"
          cd "$REPO_PATH"
        fi
        
        LATEST_HASH=$(git rev-parse --short HEAD)
        echo "LIBRESPOT_COMMIT_HASH=$LATEST_HASH" >> $GITHUB_ENV

    - name: Librespot Build Artifacts Cache
      uses: actions/cache@v3
      with:
        path: /tmp/librespot/target/
        key: ${{ runner.os }}-librespot-build-v1-${{ env.LIBRESPOT_COMMIT_HASH }}
        restore-keys: |
          ${{ runner.os }}-librespot-build-v1-

    - name: Set up and update build environment for ARM cross-compilation and packaging
      run: |
        dpkg --add-architecture armhf
        apt-get update
        apt-get install -y \
          gcc-arm-linux-gnueabihf \
          libasound2-dev:armhf \
          libpulse-dev:armhf \
          libavahi-client-dev:armhf \
          ruby rubygems
        gem install fpm

    - name: Configure PKG_CONFIG for Cross-Compilation
      run: |
        echo "PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig" >> $GITHUB_ENV
        echo "PKG_CONFIG_SYSROOT_DIR=/" >> $GITHUB_ENV

    - name: Configure Cargo Linker for ARM
      run: |
        mkdir -p ~/.cargo/
        echo "[target.arm-unknown-linux-gnueabihf]" >> ~/.cargo/config.toml
        echo "linker = \"arm-linux-gnueabihf-gcc\"" >> ~/.cargo/config.toml
        cat ~/.cargo/config.toml

    - name: Set up Rust for cross-compilation
      run: |
        rustup target add arm-unknown-linux-gnueabihf --toolchain stable
    
    - name: Log Rust environment info
      run: |
        echo "Installed toolchains:"
        rustup toolchain list

        echo "Active toolchain:"
        rustup show

        echo "Installed targets for stable:"
        rustup target list --installed --toolchain stable

        echo "Contents of ~/.rustup:"
        ls -R ~/.rustup || true

    - name: Build librespot
      run: |
        cd /tmp/librespot
        cargo build --target=arm-unknown-linux-gnueabihf --release --no-default-features --features "rustls-tls-webpki-roots alsa-backend pulseaudio-backend with-avahi"

    - name: Upload raw librespot ARM binary (Optional Debug Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: librespot-armhf-raw-binary
        path: /tmp/librespot/target/arm-unknown-linux-gnueabihf/release/librespot

    - name: Create .deb package with FPM
      id: package
      run: |
        VERSION=$(date +%Y%m%d%H%M%S)
        BIN_PATH="/tmp/librespot/target/arm-unknown-linux-gnueabihf/release/librespot"
        OUTPUT_NAME="librespot_${VERSION}_armhf.deb"
        
        POSTINST_ABS="$(pwd)/packaging/postinst"
        DEFAULT_ABS="$(pwd)/packaging/librespot.default"
        SERVICE_ABS="$(pwd)/packaging/librespot.service"
        
        echo "Packaging version: $VERSION"
        
        fpm -s dir -t deb -a armhf -n librespot -v "${VERSION}" -p "${OUTPUT_NAME}" --maintainer "More Cowbell <email@github.com>" --description "Librespot (Spotify connect client) for ARMv6/Raspberry Pi" --config-files /etc/default/librespot --after-install "${POSTINST_ABS}" --deb-systemd "${SERVICE_ABS}" "${DEFAULT_ABS}=/etc/default/librespot" "${BIN_PATH}=/usr/bin/librespot"
            
        echo "TAG_NAME=v${VERSION}" >> $GITHUB_ENV
        echo "DEB_PACKAGE_NAME=${OUTPUT_NAME}" >> $GITHUB_ENV

    - name: Upload generated .deb package as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: librespot-debian-package
        path: ${{ env.DEB_PACKAGE_NAME }}

    - name: Create GitHub Release for ARMv6 package
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: Librespot ARMv6 Package ${{ env.TAG_NAME }}
        body: |
          Automated cross-compiled Debian package (.deb) for Raspberry Pi Zero W (ARMv6/armhf).
        files: |
          ${{ env.DEB_PACKAGE_NAME }}