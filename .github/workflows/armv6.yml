name: Build librespot for ARMv6 (Pi Zero)

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Balena maintains high-quality ARMv6 images for these Debian versions
        debian_distro: [bullseye, bookworm, trixie]

    permissions:
      contents: write

    name: Build ARMv6 on ${{ matrix.debian_distro }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Register QEMU to allow running ARM binaries on x64 host
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm

    # Cache Cargo registry and target to significantly speed up subsequent builds
    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target-armv6
        key: ${{ runner.os }}-cargo-${{ matrix.debian_distro }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.debian_distro }}-

    - name: Build and Test inside ARMv6 Container
      run: |
        # Create the build script dynamically on the host
        cat <<'EOF' > build_script.sh
        set -e
        apt-get update
        # Install required development libraries for audio and networking
        apt-get install -y git curl pkg-config build-essential libasound2-dev libpulse-dev libavahi-client-dev libdbus-1-dev
        
        # Install Rust toolchain natively within the emulated environment
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        
        # Fetch the latest librespot source code
        git clone --depth 1 https://github.com/librespot-org/librespot.git /tmp/librespot-src
        cd /tmp/librespot-src
        
        # Link persistent target directory to leverage GitHub Actions cache
        if [ -d "/workspace/target-armv6" ]; then
          mkdir -p target
          cp -r /workspace/target-armv6/* target/ || true
        fi

        # Build librespot with features optimized for Raspberry Pi
        cargo build --release --no-default-features --features "rustls-tls-webpki-roots alsa-backend pulseaudio-backend with-avahi"
        
        # Verify the binary runs (QEMU will fail here if instructions are incompatible with ARMv6)
        echo "Verifying binary execution..."
        ./target/release/librespot --version
        
        # Copy the resulting binary and build artifacts back to the host workspace
        cp ./target/release/librespot /workspace/librespot-binary-${{ matrix.debian_distro }}
        cp -r target/* /workspace/target-armv6/ || true
        EOF

        chmod +x build_script.sh

        # Execute build using Balena's true ARMv6 image (optimized for Pi Zero)
        docker run --rm \
          --platform linux/arm/v6 \
          -v "${{ github.workspace }}:/workspace" \
          -w /workspace \
          balenalib/raspberry-pi-debian:${{ matrix.debian_distro }}-build \
          /bin/bash /workspace/build_script.sh

    - name: Final Architecture Validation
      run: |
        BIN="librespot-binary-${{ matrix.debian_distro }}"
        echo "Validating $BIN architecture using readelf..."
        readelf -A "$BIN" | grep "Tag_CPU_arch: v6" || (echo "❌ FAILED: Binary is not ARMv6!" && exit 1)
        echo "✅ SUCCESS: Architecture confirmed as ARMv6."

    - name: Create Debian Package (.deb)
      run: |
        # Install FPM packaging tool on the host
        sudo apt-get update && sudo apt-get install -y ruby ruby-dev rubygems build-essential
        sudo gem install --no-document fpm
        
        VERSION=$(date +%Y%m%d%H%M)
        OUTPUT_NAME="librespot_${VERSION}_armhf_${{ matrix.debian_distro }}.deb"
        
        # Handle the Debian 't64' library transition for newer releases
        ALSA_PKG="libasound2"
        [ "${{ matrix.debian_distro }}" != "bullseye" ] && ALSA_PKG="libasound2t64"
        
        # Prepare packaging files (Systemd service and default config)
        mkdir -p packaging
        echo -e "[Unit]\nDescription=Librespot\nAfter=network.target sound.target\n\n[Service]\nExecStart=/usr/bin/librespot \$LIBRESPOT_OPTS\nEnvironmentFile=/etc/default/librespot\nRestart=always\nUser=librespot\nGroup=audio\n\n[Install]\nWantedBy=multi-user.target" > packaging/librespot.service
        
        # Post-install script to create the service user
        echo -e "#!/bin/sh\nif ! id librespot >/dev/null 2>&1; then useradd -r -M -G audio librespot; fi\nsystemctl daemon-reload" > packaging/postinst 
        chmod +x packaging/postinst
        
        echo 'LIBRESPOT_OPTS="--name '\''Raspberry Pi Zero'\'' --backend alsa --bitrate 320"' > packaging/librespot.default

        # Assemble the .deb package
        fpm -s dir -t deb -a armhf -n librespot -v "${VERSION}" -p "${OUTPUT_NAME}" \
          --maintainer "Build-Bot <email@github.com>" \
          --description "Librespot for ARMv6 (Pi Zero) - Compiled on ${{ matrix.debian_distro }}" \
          --depends libpulse0 --depends "$ALSA_PKG" --depends libavahi-client3 --depends libdbus-1-3 \
          --after-install "packaging/postinst" \
          --deb-systemd "packaging/librespot.service" \
          "packaging/librespot.default=/etc/default/librespot" \
          "librespot-binary-${{ matrix.debian_distro }}=/usr/bin/librespot"
            
        echo "TAG_NAME=v${VERSION}-${{ matrix.debian_distro }}" >> $GITHUB_ENV
        echo "DEB_PACKAGE_NAME=${OUTPUT_NAME}" >> $GITHUB_ENV

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: librespot-${{ matrix.debian_distro }}
        path: ${{ env.DEB_PACKAGE_NAME }}

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: Librespot ARMv6 (${{ matrix.debian_distro }})
        body: "Automated build of Librespot for ARMv6 devices (Raspberry Pi Zero/1). Target: Debian ${{ matrix.debian_distro }}."
        files: ${{ env.DEB_PACKAGE_NAME }}