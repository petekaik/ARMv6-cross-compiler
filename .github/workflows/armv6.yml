name: Build librespot for ARMv6

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        debian_distro: [bullseye, bookworm, trixie]

    container:
      image: debian:${{ matrix.debian_distro }}
      options: --user root
    
    permissions:
      contents: write

    name: Build librespot for ARMv6 on Debian ${{ matrix.debian_distro }}

    steps:
    - name: Set up and update build environment base
      run: |
        apt-get update
        apt-get install -y \
          git pkg-config build-essential curl ruby rubygems \
          gcc-arm-linux-gnueabihf
        gem install fpm
      
    - name: Set up ARMhf dependencies
      run: |
        dpkg --add-architecture armhf
        apt-get update
        apt-get install -y \
          libasound2-dev:armhf \
          libpulse-dev:armhf \
          libavahi-client-dev:armhf \
          libdbus-1-dev:armhf

    - name: Install Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Clone librespot repository
      run: |
        REPO_URL="https://github.com/librespot-org/librespot.git"
        REPO_PATH="/tmp/librespot"
        git clone --depth 1 "$REPO_URL" "$REPO_PATH"
        cd "$REPO_PATH"
        echo "LIBRESPOT_COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

    - name: Configure Cargo for ARMv6
      run: |
        mkdir -p ~/.cargo/
        cat <<'EOF' > ~/.cargo/config.toml
        [target.arm-unknown-linux-gnueabihf]
        linker = "arm-linux-gnueabihf-gcc"
        rustflags = [
          "-C", "target-cpu=arm1176jzf-s",
          "-C", "target-feature=+vfp2,-neon,-thumb-mode",
          "-C", "link-arg=-march=armv6",
          "-C", "link-arg=-mfpu=vfp",
          "-C", "link-arg=-mfloat-abi=hard"
        ]
        
        [build]
        target = "arm-unknown-linux-gnueabihf"
        EOF
        rustup target add arm-unknown-linux-gnueabihf

    - name: Cargo Registry Cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('/tmp/librespot/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - name: Cargo Target Cache
      uses: actions/cache@v4
      with:
        path: /tmp/librespot/target
        key: ${{ runner.os }}-cargo-build-target-${{ matrix.debian_distro }}-${{ env.LIBRESPOT_COMMIT_HASH }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-target-${{ matrix.debian_distro }}-

    - name: Build librespot (Forced ARMv6)
      run: |
        cd /tmp/librespot
        
        # Create wrapper script that FORCES ARMv6 for ALL compilation
        cat <<'EOF' > /tmp/arm-gcc-wrapper.sh
        #!/bin/bash
        exec arm-linux-gnueabihf-gcc -march=armv6 -mfpu=vfp -mfloat-abi=hard -marm "$@"
        EOF
        chmod +x /tmp/arm-gcc-wrapper.sh
        
        # Set ALL environment variables to force ARMv6
        export CC_arm_unknown_linux_gnueabihf=/tmp/arm-gcc-wrapper.sh
        export CC=/tmp/arm-gcc-wrapper.sh
        export AR_arm_unknown_linux_gnueabihf=arm-linux-gnueabihf-ar
        export AR=arm-linux-gnueabihf-ar
        export CARGO_TARGET_ARM_UNKNOWN_LINUX_GNUEABIHF_LINKER=/tmp/arm-gcc-wrapper.sh
        
        # PKG config for cross compilation
        export PKG_CONFIG_ALLOW_CROSS=1
        export PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig
        export PKG_CONFIG_SYSROOT_DIR=/
        
        # Force ARMv6 in all C compilation (for build.rs scripts)
        export CFLAGS="-march=armv6 -mfpu=vfp -mfloat-abi=hard -marm"
        export CXXFLAGS="-march=armv6 -mfpu=vfp -mfloat-abi=hard -marm"
        
        # Rust flags - disable features that require ARMv7
        export RUSTFLAGS="-C target-cpu=arm1176jzf-s -C target-feature=+vfp2,-neon,-thumb-mode -C linker=/tmp/arm-gcc-wrapper.sh"
        
        # Build with rustls to avoid OpenSSL native dependencies
        cargo build --target=arm-unknown-linux-gnueabihf --release \
          --no-default-features \
          --features "rustls-tls-webpki-roots alsa-backend pulseaudio-backend with-avahi"

    - name: Validate Binary Architecture (ARMv6 Check)
      run: |
        BIN_PATH="/tmp/librespot/target/arm-unknown-linux-gnueabihf/release/librespot"
        
        echo "Checking binary architecture for $BIN_PATH..."
        ARCH_INFO=$(readelf -A "$BIN_PATH")
        echo "$ARCH_INFO"
        
        if echo "$ARCH_INFO" | grep -q "Tag_CPU_arch: v6"; then
          echo "✅ Validation passed: Binary is ARMv6 compatible."
        elif echo "$ARCH_INFO" | grep -q "Tag_CPU_arch: v7"; then
          echo "❌ ERROR: Binary is ARMv7, not ARMv6!"
          echo ""
          echo "Analyzing which dependencies may have caused ARMv7 code..."
          # Show all object files in the build
          find /tmp/librespot/target/arm-unknown-linux-gnueabihf/release -name "*.rlib" -o -name "*.a" | head -20
          exit 1
        else
          echo "⚠️  WARNING: Could not determine CPU architecture definitively."
          echo "Full readelf output:"
          echo "$ARCH_INFO"
          exit 1
        fi

        if echo "$ARCH_INFO" | grep -iq "NEON"; then
          echo "❌ ERROR: Binary contains NEON instructions, which are not supported on Pi Zero W!"
          exit 1
        fi

        echo "✅ All validations passed! Binary is safe for Raspberry Pi Zero W."

    - name: Create .deb package with FPM
      id: package
      run: |
        VERSION=$(date +%Y%m%d%H%M%S)
        BIN_PATH="/tmp/librespot/target/arm-unknown-linux-gnueabihf/release/librespot"
        OUTPUT_NAME="librespot_${VERSION}_armhf_${{ matrix.debian_distro }}.deb"
        
        if [ "${{ matrix.debian_distro }}" = "bullseye" ]; then
            ALSA_PKG="libasound2"
        else
            ALSA_PKG="libasound2t64"
        fi
        
        fpm -s dir -t deb -a armhf -n librespot -v "${VERSION}" -p "${OUTPUT_NAME}" --maintainer "Build-Bot <email@github.com>" --description "Librespot for ARMv6 (Raspberry Pi Zero W) on ${{ matrix.debian_distro }}" --depends libpulse0 --depends "$ALSA_PKG" --depends libavahi-client3 --depends libdbus-1-3 --after-install "packaging/postinst" --deb-systemd "packaging/librespot.service" "packaging/librespot.default=/etc/default/librespot" "${BIN_PATH}=/usr/bin/librespot"
            
        echo "TAG_NAME=v${VERSION}-${{ matrix.debian_distro }}" >> $GITHUB_ENV
        echo "DEB_PACKAGE_NAME=${OUTPUT_NAME}" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: librespot-${{ matrix.debian_distro }} 
        path: ${{ env.DEB_PACKAGE_NAME }}

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: Librespot ARMv6 (${{ matrix.debian_distro }})
        body: |
          Automated build for ARMv6 (Raspberry Pi Zero/1).
          Target OS: Debian ${{ matrix.debian_distro }}
        files: ${{ env.DEB_PACKAGE_NAME }}